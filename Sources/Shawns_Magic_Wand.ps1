$Wizard =@"  
            

.--''''''''''''''''''''''''-vBQl'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
y=oy_.''''''''''''''''''''.,v9\;'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
@Qkv5v-'''''''''''''-.'..^9BV..n^,''''''.''''''''''''''''''''''''''''''''''''''''''''''''''''''
@B8BeaQL.'''''''''.;eBQY-^s<..;DQm-'.Ys8,.''.''''''''''''''''''''''''''''''''''''''''''''''''''
g@09Q85QZ='''''''''.rI^r,,uzd..=_''-)Q@BY._D0*'''''''''''''''''''''''''''''''''''''''''''''''''
r@BRODBQVVr.'''''''''''''=@@E;.'''''..]='',@@|'''''''''''''''''''''''''''''''''''''''''''''''''
=G@8ONNgBZ=..'''''''''''';xO_''''''''''''',@@|'''''''''''''''''''''''''''''''''''''''''''''''''
0r@B6OONDBBr.''''''''''''''''''''''''''''',@@l'''''''''''''''''''''''''''''''''''''''''''''''''
8ZK@0NONNNg@0,..'''''''''''''''''''''''''',@@V'''''''''''''''''''''''''''''''''''''''''''''''''
,0^0B9OOOONDBB*...''''''''''''''''''''''''=@@o..'''''''''''''''''''''''''''''''''''''''''''''''
.-,=@QNOOOOONg@9,=*''''''''''''''''''''',=KBdIVn=''''''''''''''''''''''''''''''''''''''''''''''
'''.p@0NNONE0g0BRL9.'''''''''''''''''''_RE0YL^^(g;..'''''''''''''''''''''''''''''''''''''''''''
''''<@B6g0Mjl)^*Z=Z,''''''''''''''''''..^)Be]\^<ZP.''''''''''''''''''''''''''''''''''''''''''''
''...Z@9urcuuvcj3Y*,'''''''''''''''.,y3h)m8EKnVxBx..'''''''''''''''''''''''''''''''''''''''''''
.>r_rD)Ly^lR|xyByq.''''''''''''''._\YKQ@gxvGMEBBp,v.'''''''''''''''''''''''''''''''''''''''''''
,8..BrcV^^*YlY^^)Gyr].'''''''''.,**yD9QB^<^lB@p*kn.''''''''''''''''''''''''''''''''''''''''''''
x8.=B\cyllur=>KapZL\*.'''''''''.=rdENNg@n*wBBvkZr.'''''''...'''''''..'.-,-.>^...,.'._=-''''''''
p^_Md-,._=.._xV<;U-.=,..'.....-v686NONDBQBBBB^d-''''''''.xy*,,^xyXtzwwkyknL)x\xVwypZdZUIY,'..=-
,VB@@Vn-_,,'',..^D9kKZRKYr=_xOBQ6N55OO6B@Q0QB==.''''''''.q_NDDdV^===========vu5Ow)======*XpXv=(
^xY8EwByQfY..x;,BBB69D08DadQB06Odk==Y5O8@Q0QB,.'''''''''.\,@r,*laPml*==========;xLYv;======*V3U
l3QQB80@Q@ZP=|v)BB8OONU^vn6ONNOOMrl*yNNE@B0B9.'''''''''''.^@(,=vr=,;YVVycr=========*LYL|=======
QgNNNON90@BBQ@)=gBgO6OI>^yNNNiPOMONNONN6BBgBG.'''''''''''.lB=,BBQQ89ov=,^lyVl^========;v]lVM080
9OOOOOOODBEQ@QB<QBBgQ6ddNOOMx._^VdOOOOOOQBg@o.'''''''''''.p0,)BENZGZgQBEmx=,<YYL*==(YVllL\wPxr;
ONOOOOOOOOO606BBBREBDdgD9NOO=lkYZONOONN6D@B@r.'''''''''''.BK,zQ3)xlYYwN6DQBQ6k;,rBZx*=====vpYjU
OOOOOOOOOOOOOOg@0OOB6_<YwH6gBBBBBBBBBBBgbM3y>\'''''''''''.@c,M8vdNOOOOOOOOONRgQvv@n===^\cwjPu)=
OOOOOOOOOOOOONNRNOOQ@v..''..--------...-;LwaV_'''''''''''.@Y,RgbNOOOOOOOOOOONN8HY@r==gQMr======
omN9NNONOOOOOOONOOOR@Q-.'''''''''''''''''''''''''''''''''.@l,d8NOOOOOOOOOOOOON8ZV@;==8^)VIaGjL;
<h9BQNOOOOOOOOOOOONOQ@c.'''''''''''''''''''''''''''''''.v_@L,VQ6OOOOOOOOOOOOONQpsB===B*=;==<nHE
NOg@B6ONOOOOOMc,rxqORB@_'''''''''''''''''''''''''''..,;|b,By,,M006ONONOOOOOON6Bld6===BL=)nIhl<*
ONB@@ROOOOOOOZ^.<vZOOQ@\'''''''''''''''''''''''''''-=rYwlmB0zi;=iH00NOOOOOOOORB=8H===Bu=rYlr;==
9QBl@DONOOOOOOM3NNOOOE@Z..''''''''''''''''''.'.=rlfdD0plxLytmOQB8PulzpgD6OOON89,gU===BV===;vL;=
BB;=@0OOOOOOOOOOOOOOO6BB=.r,''''''''''''.=.vGN00N3nlcmGjoIGeZpyVuKRBg3YYXOQQgBk,OK===BV===rx(cr
B*.v@ROOZddOOOOOOOOOOOB@l.Vr''''''''''''w);H|^===55IYiH9MIcK8MUzIhyvlMBQqx;rvx=,Mf===Bk===\(,kl
L..v@9OOx=,yNOOOOOOOOOg@D.I|'''''''''''.K0(p0P|===xymEenHD0Nux9QOmnyPmyr]K0DV=,,OV===BM====;x(=
-..yBNZx;.=lZOOOOOOOOO6B@;rM,'''''''''''.|Xsll0gs*===rVOeY(dBg8y]pdfjVlPmc^*yOdlQr;rxBp========
...RQOOOoYONNOOOOOOOOOOEBQ-,M-''''''''''''''=LYLc88a)===^YmZIvlOgQEVjZMUXxGqm;;8MyY*=@s=======*
;.;BgNOOOOONNOOOOOOOpOOOD@y.=x.'''''''''''''''.^=.rsB0o*====\I9BzYUPyVd3P3y6Q;>B-'''.pqV\=====i
^.l@ROOOOOOOOOOOOONd,^;kNQ@x.;_'''''''''''''''''''..-\eQRz*====rymGzQD5zvl@8*=ob.'''''.=YnVkv;n
..DB6OOOOOOOOOOOOOGc._,vGNBB,.'''''''''''''''''''''''''.=YM0dV*====Y3mkVQB]==\B;''''''''''.,VbM
.^@8OOOOOOOOOOOOOONh;adUPORBZ..''''''''''''''''''''''''''''-<VZZPx;==;xhw;===hB.''''''''''''_^V
;BQNOOOOOOOOOOOOOOONNONNNOO9Bv.''''''''''''''''''''''''''''''''',lHdl^=======Qj._''''''''''''''
0B9OOOOOOOOOOOOOOOOOOOOOOOOO80,'''''''''''''''''''''''''''''''''''.,wM3Z5wyzMV,K^''''''''''''''
@gNOOOOOOOOOOOOOOOOOOOOOOOOONB8.''''''''''''''''''''''''''''''''''''''.,vK9EM3Zx.''''''''''''''
gN6D8BBBBBQ09NNOOOOOOONDgQBBQB@,.'''''''''''''''''''''''''''''''''''''''''.--''''''''''''''''''
QB@@@@@@@@@@gQQg000gQBB@@@@@@p)(=''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Q@@@@@@@@Bm,'.,^\]v==lOQB@@@Q)w='''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
idQBBBg3\,'''''''''''''..,,,=lY.'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

 _____ _                          _      ___  ___            _        _    _                 _ 
/  ___| |                        ( )     |  \/  |           (_)      | |  | |               | |
\ ``--.| |__   __ ___      ___ __ |/ ___  | .  . | __ _  __ _ _  ___  | |  | | __ _ _ __   __| |
 ``--. \ '_ \ / _`` \ \ /\ / / '_ \  / __| | |\/| |/ _`` |/ _`` | |/ __| | |/\| |/ _`` | '_ \ / _`` |
/\__/ / | | | (_| |\ V  V /| | | | \__ \ | |  | | (_| | (_| | | (__  \  /\  / (_| | | | | (_| |
\____/|_| |_|\__,_| \_/\_/ |_| |_| |___/ \_|  |_/\__,_|\__, |_|\___|  \/  \/ \__,_|_| |_|\__,_|
                                                        __/ |                                  
                                                       |___/ 
                                                                                         
"@

Write-Host $Wizard -ForegroundColor Cyan
$global:Error_Num = 0

Write-Host "Shawn's Magic Wand v2.0.1" -ForegroundColor Gray

Write-Host "© 2022-2023 Shawn McCausland" -ForegroundColor Gray
Write-Host " "
Write-Host "Thank you for choosing Shawn's Magic Wand. This software is provided for free and `"as-is`", without warranty of any kind under a MIT License. Find full license at " -ForegroundColor Gray -NoNewline
Write-Host "www.https://github.com/shawn-mcc/Magic-Wand/blob/main/LICENSE" -ForegroundColor DarkGray
Write-Host " "

###Function Definitions###

Function Add-NoteProperty {
    Param(
        $InputObject,
        $Property,
        $Value,
        [switch]$Force,
        [char]$escapeChar = '#'
    )
    Process {
        $path = $Property -split "\."
        $obj = $InputObject
        # loop all but the very last property
        for ($x = 0; $x -lt $path.count -1; $x ++) {
            $propName = $path[$x] -replace $escapeChar, '.'
            if (!($obj | Get-Member -MemberType NoteProperty -Name $propName)) {
                $obj | Add-Member NoteProperty -Name $propName -Value (New-Object PSCustomObject) -Force:$Force.IsPresent
            }
            $obj = $obj.$propName
        }
        $propName = ($path | Select-Object -Last 1) -replace $escapeChar, '.'
        if (!($obj | Get-Member -MemberType NoteProperty -Name $propName)) {
            $obj | Add-Member NoteProperty -Name $propName -Value $Value -Force:$Force.IsPresent
        }
    }
}

Function Critical_Error($ev, $Wiz_Message, $Allow_Continue) {
    Write-Warning "A CRITICAL ERROR has caused magic wand to stop. Please review the error details and Wizard Recomendations below: "
    Write-Host "Error Details: " $ev -ForegroundColor Red
    Write-Host "Wizard Recomendations: " $Wiz_Message -ForegroundColor Cyan
    If($Allow_Continue -eq "True"){
        Sad_Beeps
        $confirm = Read-Host "Press Y to continue anyway (not recommended), or any other key to quit"
        If(!($confirm -eq "y" -or $confirm -eq "Y")){
            Write-Host "The magic has fizzled out. Press any key to exit and try again (Ritual was Canceled)" -ForegroundColor Red
            Read-Host
            Exit
        }Else{
            Write-Host "Continuing despite the error. This will be noted in Work Summary." -ForegroundColor Green
            $err_msg = "Critical Error Overridden by user - " + $ev
            Add_Error -err_msg $err_msg -wiz_rec $Wiz_Message
            Break
        }
    }Else {
        Write-Host "Magic Wand cannot continue with this error present. Press any key to exit (Critical Error Unresolvable)" -ForegroundColor Red
        Sad_Beeps
        Read-Host
        Exit
    }
}

Function Add_Error($err_msg, $wiz_rec){
    $Components_Json = Get-Content .\Spell_Components.json -Raw | ConvertFrom-Json
    $Errors = $Components_Json.Spell_Components.Ritual_Details.Errors
    $Error_Count = $Components_Json.Spell_Components.Ritual_Details.Error_Count
    $Error_Count = $Error_Count += 1
    $Error_Num = "Error_" + $Error_Count

    
    $Error_Prop = "Spell_Components.Ritual_Details.Errors." + $Error_Num + ".Error_Message"
    Add-NoteProperty -InputObject $Components_Json -Property $Error_Prop -Value $err_msg
    $Error_Prop = "Spell_Components.Ritual_Details.Errors." + $Error_Num + ".Wiz_Rec"
    Add-NoteProperty -InputObject $Components_Json -Property $Error_Prop -Value $wiz_rec
    Add-NoteProperty -InputObject $Components_Json -Property "Spell_Components.Ritual_Details.Errors" -Value $Error_Num
    $Error_Prop = "Spell_Components.Ritual_Details.Errors." + $Error_Num
    $Components_Json.Spell_Components.Ritual_Details.Error_Count = $Error_Count
    Update_Json

}

Function Update_Steps($name){
    $Components_Json = Get-Content .\Spell_Components.json -Raw | ConvertFrom-Json
    $type = $Components_Json.Spell_Components.Ritual_Details.Type
    $total = $Components_Json.Spell_Components.Ritual_Details.Total_Steps
    $current = $Components_Json.Spell_Components.Ritual_Details.Current_Step
    $current += 1
    $Components_Json.Spell_Components.Ritual_Details.Current_Step = $current
    $out = $type + " Step: " + $current + "/" + $total + " - " + $name
    Write-Host " "
    Write-Host "====================================================" -ForegroundColor Cyan
    Write-Host $out -ForegroundColor Cyan
    Write-Host "====================================================" -ForegroundColor Cyan
    Write-Host " "
    Update_Json

}

Function Update_Json{
$Components_Json | ConvertTo-Json -Depth 10 | Out-File .\Spell_Components.json
$Components_Json = Get-Content .\Spell_Components.json -Raw | ConvertFrom-Json
}

Function Happy_Beeps{
    $HappySong = New-Object System.Media.SoundPlayer
    $HappySong.SoundLocation = "$env:windir\Media\Ring10.wav"
    $HappySong.Play()
}

Function Sad_Beeps{
    $SadSong = New-Object System.Media.SoundPlayer

    for (($i=0);$i -lt 6; $i++){
        If($i % 2 -eq 0){
        $SadSong.SoundLocation = "$env:windir\Media\Windows Error.wav"
        $SadSong.Play()
        Start-Sleep 1
        }Else{
        $SadSong.SoundLocation = "$env:windir\Media\Windows Critical Stop.wav"
        $SadSong.Play()
        Start-Sleep 1
        }
    }
}

Function Gather_Suspect_Info($Type, $Num_Steps){
    Write-Host "Gathering a bit of information before we begin..." -ForegroundColor Yellow
    $Components_Json = Get-Content .\Spell_Components.json -Raw | ConvertFrom-Json
    $Components_Json.Spell_Components.Ritual_Details.Type = $Type
    $Components_Json.Spell_Components.Ritual_Details.Total_Steps = $Num_Steps
    $Components_Json.Spell_Components.Ritual_Details.Start_Time = Get-Date | Get-Date -Format "MM/dd/yyyy HH:mm:ss" 
    $Suspect_Info = $Components_Json.Spell_Components.Suspect_Details
    $deets = Get-ComputerInfo

    $Comp_Name = $deets | Select-Object -Property CsName
    Write-Host "Computer Name: " $Comp_Name.psobject.properties.value -ForegroundColor Magenta
    $Suspect_Info.ComputerName = $Comp_Name.psobject.properties.value

    $Account_Name = $deets | Select-Object -Property CsPrimaryOwnerName
    Write-Host "Account Name: " $Account_Name.psobject.properties.value -ForegroundColor Magenta
    $Suspect_Info.AccountName = $Account_Name.psobject.properties.value

    $MF = $deets | Select-Object -Property CsManufacturer
    If($MF.psobject.properties.value -eq "System manufacturer"){
        Write-Host "Manufacturer: Custom Build"  -ForegroundColor Magenta
        $Suspect_Info.Manufacturer = "Custom Build"
    }Else{
        Write-Host "Manufacturer: " $MF.psobject.properties.value -ForegroundColor Magenta
        $Suspect_Info.Manufacturer = $MF.psobject.properties.value
    }

    $Model = $deets | Select-Object -Property CsModel
    If($Model.psobject.properties.value -eq "System Product Name"){
        Write-Host "Model: Custom Build"  -ForegroundColor Magenta
        $Suspect_Info.Model = "Custom Build"
    }Else{
        Write-Host "Model: " $Model.psobject.properties.value -ForegroundColor Magenta
        $Suspect_Info.Model = $Model.psobject.properties.value
    }

    $SN = $deets | Select-Object -Property BiosSeralNumber
    If($SN.psobject.properties.value -eq "System Serial Number"){
        Write-Host "Serial Number: Custom Build"  -ForegroundColor Magenta
        $Suspect_Info.SerialNumber = "Custom Build"
    }Else{
        Write-Host "Serial Number: " $SN.psobject.properties.value -ForegroundColor Magenta
        $Suspect_Info.SerialNumber = $SN.psobject.properties.value
    }

    $OS = $deets | Select-Object -Property WindowsProductName
    Write-Host "OS: " $OS.psobject.properties.value -ForegroundColor Magenta
    $Suspect_Info.OS = $OS.psobject.properties.value

    $OSV = $deets | Select-Object -Property WindowsBuildLabEx
    Write-Host "Os Version: " $OSV.psobject.properties.value -ForegroundColor Magenta
    $Suspect_Info.OSVersion = $OSV.psobject.properties.value

    $BIOS = $deets | Select-Object -Property BiosVersion
    Write-Host "BIOS: " $BIOS.psobject.properties.value -ForegroundColor Magenta
    $Suspect_Info.BIOS = $BIOS.psobject.properties.value

    $BIOS_V = $deets | Select-Object -Property BiosDescription
    Write-Host "BIOS Version: " $BIOS_V.psobject.properties.value -ForegroundColor Magenta
    $Suspect_Info.BIOSVersion = $BIOS_V.psobject.properties.value
    

    $BIOS_T = $deets | Select-Object -Property BiosFirmwareType
    If($BIOS_T.psobject.properties.value -eq "Uefi"){
        Write-Host "BIOS Type: UEFI"  -ForegroundColor Magenta
        $Suspect_Info.BIOSType = "UEFI"
    }Else{
        Write-Host "BIOS Type: Legacy" -ForegroundColor Magenta
        $Suspect_Info.BIOSType = "Legacy"
    }

    $Admin_PW_Status | Select-Object -Property CsAdminPasswordStatus
    If($Admin_PW_Status.psobject.properties.value -eq "Enabled"){
        Write-Host "BIOS Admin PW: Enabled"  -ForegroundColor Magenta
        $Suspect_Info.AdminPWStatus = "Enabled"
    }Else{
        Write-Host "BIOS Admin PW: Disabled"  -ForegroundColor Magenta
        $Suspect_Info.AdminPWStatus = "Disabled"
    }

    Update_Json
    Write-Host "Ready to begin! The magic is starting." -ForegroundColor Green
}

Function Install_NuGet{
        Write-Host "Installing NuGet..." -ForegroundColor Yellow
        Install-PackageProvider -Name NuGet -Force -ErrorAction SilentlyContinue -ErrorVariable ev
        If($ev){
            Cricical_Error -ev $ev -Wiz_Message "Unable to install NuGet Library. You may proceed, but some updates may fail." -Allow_Continue "True"
            }Else{
                Write-Host "Installed NuGet!" -ForegroundColor Green
            }
        Write-Host "Importing PowerShell Windows Update Module..." -ForegroundColor Yellow
        Install-Module -Name PSWindowsUpdate -Force -ErrorAction SilentlyContinue -ErrorVariable ev
        If($ev){
            Cricical_Error -ev $ev -Wiz_Message "Unable to import PSWindowsUpdate (This is a very weird error - please contact the wizard himself if you encounter)" -Allow_Continue "False"
            }Else{
                Write-Host "PsWindowsUpdate Module Successfuly imported!" -ForegroundColor Green
            }
}

Function Do_Windows_Updates{
        Import-Module PSWindowsUpdate
        Write-Host "Preparing Windows Updates..." -ForegroundColor Yellow
        Get-WindowsUpdate -ErrorAction SilentlyContinue -ErrorVariable ev
        If($ev){
            Add_Error -err_msg $ev -wiz_msg "Couldn't find updates from PsWindowsUpdate Module" 
            }
        Write-Host "Updates gathered! Installing..." -ForegroundColor Yellow
        Install-WindowsUpdate -AcceptAll -IgnoreReboot -ErrorAction SilentlyContinue -ErrorVariable ev
        If($ev){
            Add_Error -err_msg $ev -wiz_msg "A Windows update failed. See error message for more details" 
            }
        Write-Host "Completed Windows Updates!..." -ForegroundColor Green

}

Function Create_Restore_Point{
    Write-Host "Creating System Restore Point..." -ForegroundColor Yellow
    Checkpoint-Computer -Description "Magic Wand Restore Point" -RestorePointType "MODIFY_SETTINGS" -WarningVariable wv -WarningAction SilentlyContinue -ErrorAction SilentlyContinue -ErrorVariable wv
    If ($wv -like "A new system restore point cannot be created because one has already been created within the past*"){
        Write-Warning "A new restore point was not created because one has been made in the past 24 hours. This is usually good enough and not a cause for worry"
        Add_Error -err_msg "A new system restore point cannot be created because one has already been created within the past 1440 minutes. The frequency of restore point creation can be changed by creating the DWORD value \u0027SystemRestorePointCreationFrequency\u0027 under the registry key \u0027HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\u0027. The value of this registry key indicates the necessary time interval (in minutes) between two restore point creation. The default value is 1440 minutes (24 hours)." -wiz_rec "A new restore point was not created because one has been made in the past 24 hours. This is usually good enough and not a cause for worry"
    }ElseIf($wv -like "*the service cannot be started because it is disabled or does not have enabled devices associated with it*"){
        Write-Warning "System Restore point is currently disabled. This is common on older PC's, or those that originally came in S mode. Magic Wand will attempt to enable it for you."
        
        Try{
            Enable-ComputerRestore -Drive "C:\"
            Checkpoint-Computer -Description "Magic Wand Restore Point" -RestorePointType "MODIFY_SETTINGS" -WarningVariable wv -WarningAction SilentlyContinue -ErrorAction SilentlyContinue -ErrorVariable wv
        }Catch{
            Add_Error -err_msg "The Restore Point service cannot be started because it is disabled or does not have enabled devices associated with it." -wiz_rec "The suspect does not have Restore Point enabled, and Magic Wand was not able to activate it. The suspect may not support this feature."
            Write-Warning "The suspect does not have Restore Point enabled, and Magic Wand was not able to activate it. The suspect may not support this feature."
        }

        }Else{
        Write-Host "System Restore Point Created! " -ForegroundColor Green
}
}

Function Do_App_Updates{
    Write-Host "Updating Applicable Apps..." -ForegroundColor Yellow
    Write-Output y|winget upgrade -h --all
    Write-Host "App Updates completed" -ForegroundColor Green
}

Function Start_Grand_Finale{
    
    $Components = $env:USERPROFILE + "\Desktop\Spell_Components.json"
    $global:Components_Json = Get-Content $Components -Raw  -ErrorVariable ev  | ConvertFrom-Json 
    Write-Host "Resuming " $Components_Json.Spell_Components.Ritual_Details.Type -ForegroundColor Cyan

    ###1 - Recheck Windows Updates###
    Update_Steps -name "Windows Updates Pt 2"
    Write-Host "Checking Windows Updates after Reboot" -ForegroundColor Cyan
    Do_Windows_Updates

    ###2 - Empty Recycle Bin###
    Update_Steps -name "Emptying the Recycle Bin"
    Write-Host "Emptying Recycle Bin..." -ForegroundColor Yellow
	Clear-RecycleBin -Confirm:$False -ErrorAction SilentlyContinue -ErrorVariable ev
    If($ev){
       
    }Else{
        Write-Host "Successfully emptied recycle bin!" -ForegroundColor Green
    }

    ###3 - Reset Powershell Profile###
    Update_Steps -name "Resetting Powershell Profile"
	Write-Host "Removing WindowsPowerShell folder..." -ForegroundColor Yellow
	if (Test-Path "$env:userprofile\Documents\WindowsPowerShell") {
  	Remove-Item $env:userprofile\Documents\WindowsPowerShell -Recurse
	}
	Write-Host "Removing WindowsPowerShell folder completed" -ForegroundColor Green

    ###4 - Clear Recent Items###
    Update_Steps -name "Clearing Recent Items in Explorer"
    Write-Host "Clearing Recent Items..." -ForegroundColor Yellow
	Get-ChildItem $env:appdata\Microsoft\Windows\Recent\* -Recurse | Remove-Item -Force -Recurse
	Write-Host "Clearing Recent Items completed" -ForegroundColor Green

    ###4.5 Restore Point (NPS ONLY)###
    If($Components_Json.Spell_Components.Ritual_Details.Type -eq "NPS"){
        Update_Steps -name "Creating a restore point"
        Create_Restore_Point
    }

    ###5 - Finish Report###
    $Components_Json = Get-Content $Components -Raw  -ErrorVariable ev  | ConvertFrom-Json 
	Write-Host "========================================================================================" -ForegroundColor Cyan
    Write-Host "              Magic Wand Ritual Report                  " -ForegroundColor Cyan
    Write-Host "========================================================================================" -ForegroundColor Cyan
    Write-Host "The Wizard has finished his ritual. Please review the report below and confirm results manually. Thank you for using Shawn's Magic Wand!" -ForegroundColor Cyan
    Write-Host 
    Write-Host "========================================================" -ForegroundColor Magenta
    Write-Host "                 Suspect Details                        " -ForegroundColor Magenta
    Write-Host "========================================================" -ForegroundColor Magenta
    $Suspect_Details = $Components_Json.Spell_Components.Suspect_Details
    Write-Host "Computer Name: " $Suspect_Details.ComputerName -ForegroundColor Magenta
    Write-Host "Account Name: " $Suspect_Details.AccountName -ForegroundColor Magenta
    Write-Host "Manufacturer: " $Suspect_Details.Manufacturer -ForegroundColor Magenta
    Write-Host "Computer Model: " $Suspect_Details.Nodel -ForegroundColor Magenta
    Write-Host "Serial Number: " $Suspect_Details.SerialNumber -ForegroundColor Magenta
    Write-Host "OS: " $Suspect_Details.OS -ForegroundColor Magenta
    Write-Host "OS Version: " $Suspect_Details.OSVersion -ForegroundColor Magenta
    Write-Host "BIOS: " $Suspect_Details.BIOS -ForegroundColor Magenta
    Write-Host "Bios Version: " $Suspect_Details.BIOSVersion -ForegroundColor Magenta
    Write-Host "BIOS Type: " $Suspect_Details.BIOSType -ForegroundColor Magenta
    Write-Host "Admin Password Status: " $Suspect_Details.AdminPWStatus -ForegroundColor Magenta
    Write-Host " "
    Write-Host "========================================================" -ForegroundColor Gray 
    Write-Host "                 Ritual Details                       " -ForegroundColor Gray
    Write-Host "========================================================" -ForegroundColor Gray
    $Ritual_Details = $Components_Json.Spell_Components.Ritual_Details
    Write-Host "Ritual Type: " $Ritual_Details.Type -ForegroundColor Gray 
    Write-Host "Start Time: " $Ritual_Details.Start_Time -ForegroundColor Gray 
    $End_Time = Get-Date
    Write-Host "Completed Time: " $End_Time  -ForegroundColor Gray
    Write-Host "Tasks the Wizard attempted to complete: " -ForegroundColor Cyan
    If($Ritual_Details.Type -eq "NPS"){
        Write-Host "1 - Update Winget Libraries" -ForegroundColor Cyan
        Write-Host "2 - Install Google Chrome" -ForegroundColor Cyan
        Write-Host "3 - Install Adobe Reader" -ForegroundColor Cyan
        Write-Host "4 - Install VLC Media Player" -ForegroundColor Cyan
        Write-Host "5 - Windows Updates" -ForegroundColor Cyan
        Write-Host "6 - Application Updates" -ForegroundColor Cyan
        Write-Host "7 - Create Dispel Magic Script" -ForegroundColor Cyan
        Write-Host "8 - System Reboot" -ForegroundColor Cyan
        Write-Host "9 - Re-Check Windows Updates" -ForegroundColor Cyan
        Write-Host "10 - Empty Recycle Bin" -ForegroundColor Cyan
        Write-Host "11 - Remove PowerShell folder (to reset ExecutionPolicy)" -ForegroundColor Cyan
        Write-Host "12 - Delete Recent Items" -ForegroundColor Cyan
        Write-Host "13 - Create a Restore Point" -ForegroundColor Cyan
        Write-Host "14 - Run Dispel Magic (Self Deletion Script)" -ForegroundColor Cyan
    }ElseIf($Ritual_Details.Type -eq "Tune Up"){
        Write-Host "1 - Create a Restore Point" -ForegroundColor Cyan
        Write-Host "2 - ChkDsk" -ForegroundColor Cyan
        Write-Host "3 - DISM" -ForegroundColor Cyan
        Write-Host "4 - SFC" -ForegroundColor Cyan
        Write-Host "5 - Delete User Tmp Files" -ForegroundColor Cyan
        Write-Host "6 - Delete Operating System Tmp Files" -ForegroundColor Cyan
        Write-Host "7 - Delete Pre-Fetch Files" -ForegroundColor Cyan
        Write-Host "8 - Disk Cleanup" -ForegroundColor Cyan
        Write-Host "9 - Drive Optimization" -ForegroundColor Cyan
        Write-Host "10 - Windows Updates" -ForegroundColor Cyan
        Write-Host "11- App Updates" -ForegroundColor Cyan
        Write-Host "12 - Create Dispel Magic (Self Deletion Script)" -ForegroundColor Cyan
        Write-Host "13 - System Reboot" -ForegroundColor Cyan
        Write-Host "14 - Re-Check Windows Updates" -ForegroundColor Cyan
        Write-Host "15 - Empty Recycle Bin" -ForegroundColor Cyan
        Write-Host "16 - Remove PowerShell folder (to reset ExecutionPolicy)" -ForegroundColor Cyan
        Write-Host "17 - Delete Recent Items" -ForegroundColor Cyan
        Write-Host "18 - Run Dispel Magic (Self Deletion Script)" -ForegroundColor Cyan
        Write-Host " "
        Write-Host " "
    }
    If(!($Ritual_Details.Error_Count -eq 0)){
        $Errors = $Ritual_Details.Errors
        Write-Host "Magic Wand Encountered " $Ritual_Details.Error_Count.ToString() " Errors during the ritual. Please see details below and manually address them." -ForegroundColor Red
        Write-Host ""
        For($ErrorCount = 1; $ErrorCount -le $Ritual_Details.Error_Count; $ErrorCount++ ){
           $current = "Error_" + $ErrorCount
           $error = $Errors.$current
           Write-Host "===========================================" -ForegroundColor Gray
           Write-Host "Error " $ErrorCount ": " -ForegroundColor Gray
           Write-Host "Error Message: " $error.Error_Message -ForegroundColor Red
           Write-Host "The Wizard's Advice: " $error.Wiz_Rec -ForegroundColor Cyan
           Write-Host "===========================================" -ForegroundColor Gray
           Write-Host " "
     
        }
    }Else{
        Write-Host " "
        Write-Host "Magic Wand Encountered 0 Issues and completed it's ritual!" -ForegroundColor Green
    }

    Write-Host "Thank you for using Shawn's Magic Wand! The wizard's ritual has been completed." -ForegroundColor Cyan
    Write-Warning "Please note that this program will now delete itself and it's report will be lost, so please make sure you make a note of any errors."
    Write-Warning "You MUST press ENTER and allow the program to exit itself. If you simply close it, the deletion script of Dispel Magic will not trigger and will lead to UAC attempting to relaunch the magic wand on every reboot."
    Write-Host "Press ENTER when you are ready to exit." -ForegroundColor Cyan
    Happy_Beeps
    Read-Host

    ###6 - Self Deletion###
    Clear-Host
    Write-Host "Casting Dispel Magic to remove all traces of Magic Wand..." -ForegroundColor Yellow
    Update_Steps -name "Dispelling Magic"

    
    $ComponentPath = $env:USERPROFILE + "\Desktop\Spell_Components.json"
    $DispelMagicPath = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\Dispel_Magic.bat"
    #Assume there is an error until we prove otherwise
    $ComponentHasError = $True
    $DispelHasError = $True
        
        ###1 - Delete Spell Components###

        Write-Host "Attempting to remove spell components from " $ComponentPath -ForegroundColor Yellow
        Remove-Item -Path $ComponentPath -Recurse
        If(!(Test-Path $ComponentPath)){
            Write-Host "Spell Components Sucessfully Deleted" -ForegroundColor Green
            $ComponentHasError = $False
        }Else{
            Write-Warning "Unable to automatically delete Spell Components. Please manually remove from " $ComponentPath
            }

        ###2 - Delete Dispel Magic###

        Write-Host "Attempting to remove Dispel Magic from " $DispelMagicPath -ForegroundColor Yellow
        Remove-Item -Path $DispelMagicPath -Recurse
        If(!(Test-Path $DispelMagicPath)){
            Write-Host "Dispel Magic Sucessfully Deleted" -ForegroundColor Green
            $DispelHasError = $False
        }Else{
            Write-Warning "Unable to automatically delete Dispel Magic. Please manually remove from " $DispelMagicPath
            }

        ###3 - Delete Magic Wand###

        #A running exe cannot delete itself, so we need to make a small batch script to delete it. Use a 10 second timeout to make sure script finishes before attempting to delete but before reboot happens

            $DispelContents = @"
            @echo OFF
            timeout 10 
            cd $env:USERPROFILE\Desktop
            rm Shawns_Magic_Wand.exe
            rm Dispel_Magic_2.bat
"@
            New-Item -Path "$env:USERPROFILE\Desktop" -name "Dispel_Magic_2.bat" -Type "file" -Value $DispelContents
            


        ###4 - Final Check###

        If (($ComponentHasError -eq $False) -and ($DispelHasError -eq $False)){
            Invoke-Expression -Command "$env:USERPROFILE\Desktop\Dispel_Magic_2.bat" #call the batch here so that it doesn't trigger if there was an error removing a different component
            Happy_Beeps
            $wshell = New-Object -ComObject Wscript.Shell
            $wshell.Popup("Spell Components and Dispel Magic have been removed from the computer. In 45 seconds, it will reboot one last time and then it should be good to go! Thank you for choosing Shawn's Magic Wand!",30,"Ritual Complete",0x0)
            Shutdown /r /t 45
            Exit
        }Else{
            Write-Warning "Dispel Magic was unable to remove one or more elements of Shawn's Magic Wand. Please reference the errors above and manually delete them before proceeding."
            Write-Host "Press ENTER key to exit"
            Sad_Beeps
            Read-Host
            Exit
            }


    

}

###BEGIN PROGRAM###

###Make Sure Running as Admin###
Write-Host "Ensuring Magic Wand has Administrator Privileges..." -ForegroundColor Yellow
$AdminTest = [Security.Principal.WindowsIdentity]::GetCurrent();
If(!((New-Object Security.Principal.WindowsPrincipal $AdminTest).IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator))){
    Critical_Error -ev "NOT RUNNING AS ADMIN" -Wiz_Message "Magic Wand requries being run as an Administrator in order to work. Please exit and relaunch by right-clicking on Shawn's Magic Wand and select 'Run as Administrator'." -Allow_Continue "False"
}Else{
    Write-Host "Admin Privileges confirmed!" -ForegroundColor Green
    }

###Locate Spell Components###
Write-Host "Checking for active Spell Components..." -ForegroundColor Yellow
$Comp_Json = $env:USERPROFILE + "\Desktop\Spell_Components.json"
If(Test-Path $Comp_Json){
    Write-Host "Ritual in-progress detected!" -ForegroundColor Green
    Start_Grand_Finale 
}Else{
    Write-Host "Spell Components not detected - Building new template..." -ForegroundColor Yellow
    Copy-Item "./Spell_Components.json" -Destination "$env:USERPROFILE\Desktop"
If(Test-Path $Comp_Json){
    Write-Host "Spell Components Template Created!" -ForegroundColor Green
}Else{
    Critical_Error -ev "Cannot access path '$Comp_Json'" -Wiz_Message "SPELL COMPONENTS TEMPLATE NOT ABLE TO BE GENERATED - ABORTING" -Allow_Continue "False"
}

###Move to Desktop Path###
Write-Host "Navigating to Desktop Directory..." -ForegroundColor Yellow
$desktop = $env:USERPROFILE + "\Desktop"
Set-Location $desktop
Write-Host "Now operating at " $desktop -ForegroundColor Green

###Verify Location on Desktop###
Write-Host "Verifying Magic Wand is located on the Desktop..." -ForegroundColor Yellow
$WandDeskLoc = $env:USERPROFILE + "\Desktop\Shawns_Magic_Wand.exe"


If(Test-Path $WandDeskLoc){
    Write-Host "Magic Wand verified on Desktop" -ForegroundColor Green
}Else{
    Write-Host "Magic Wand not detected, attempting to see if OneDrive Desktop is active..." -ForegroundColor Yellow
    $OneDriveDeskLoc = $env:USERPROFILE +"\OneDrive\Desktop\Shawns_Magic_Wand.exe"
    If(Test-Path $OneDriveDeskLoc){
        Critical_Error -ev "DESKTOP SYNCED TO ONEDRIVE" -Wiz_Message "It appears that the user's Desktop is synced to onedrive. Please move Shawn's Magic Wand to the local desktop and try again." -Allow_Continue "False"
    }Else{
        Critical_Error -ev "NOT LOCATED ON DESKTOP" -Wiz_Message "Shawns_Magic_Wand.exe MUST be located on the desktop to function properly. Please exit and move the file before trying again." -Allow_Continue "False"
    }
}

###Check to see if pesky Mcafee is in the way###
Write-Host "Checking for conflicting software..." -ForegroundColor Yellow
$InstalledSoftware = Get-ChildItem "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall"
ForEach($software in $InstalledSoftware){
    If($software.GetValue('DisplayName') -Like "*McAfee*"){
        Critical_Error -ev "McAfee detected" -Wiz_Message "McAfee is particularly stubborn and sometimes causes errors in the script. It is highly recommended that you uninstall McAfee (and WebAdvisor by McAfee) and reboot your computer before using this tool." -Allow_Continue "True"
     }
    
}
Write-Host "No Conflicts detected, or they have been overridden by the user" -ForegroundColor Green

###Spell Selection###

Write-Host "Thank you for using choosing Shawn's Magic Wand (v. 2.0.1). Please select a spell from the options below: " -ForegroundColor Cyan
Write-Host "1 - New PC Setup " -ForegroundColor Cyan
Write-Host "2 - Tune Up " -ForegroundColor Cyan
$SpellSelection = Read-Host "Enter the number for the spell you want the wizard to cast "

Switch($SpellSelection){

1 {

###BEGIN NPS###

Write-Host "You have chosen to cast NPS. This ritual is ideal for first-time setup of a new PC. The following actions will be performed: " -ForegroundColor Cyan
Write-Host "1 - Update Winget Libraries" -ForegroundColor Cyan
Write-Host "2 - Install Google Chrome" -ForegroundColor Cyan
Write-Host "3 - Install Adobe Reader" -ForegroundColor Cyan
Write-Host "4 - Install VLC Media Player" -ForegroundColor Cyan
Write-Host "5 - Windows Updates" -ForegroundColor Cyan
Write-Host "6 - Application Updates" -ForegroundColor Cyan
Write-Host "7 - Create Dispel Magic Script" -ForegroundColor Cyan
Write-Host "8 - System Reboot" -ForegroundColor Cyan
Write-Host "9 - Re-Check Windows Updates" -ForegroundColor Cyan
Write-Host "10 - Empty Recycle Bin" -ForegroundColor Cyan
Write-Host "11 - Remove PowerShell folder (to reset ExecutionPolicy)" -ForegroundColor Cyan
Write-Host "12 - Delete Recent Items" -ForegroundColor Cyan
Write-Host "13 - Create a Restore Point" -ForegroundColor Cyan
Write-Host "14 - Run Dispel Magic (Self Deletion Script)" -ForegroundColor Cyan
$confirm = Read-Host "Are you sure you wish to proceed? (Press Y to confirm) "
If(!($confirm -eq "y" -or $confirm -eq "Y")){
    Write-Host "The magic has fizzled out. Press any key to exit and try again (Ritual was Canceled)" -ForegroundColor Red
    Read-Host
    Exit
}Else{

    Write-Host "NPS confirmed. The wizard is beginning his ritual" -ForegroundColor Green

    ###Gather Suspect Info###
        
    Gather_Suspect_Info -Type "NPS" -Num_Steps 14

    ###1 - Update Winget Libraries###
        Update_Steps -name "Updating Winget"
        Write-Host "Updating Winget Libraries to latest version..." -ForegroundColor Yellow
        # Get Latest Download URL
        $URL = "https://api.github.com/repos/microsoft/winget-cli/releases/latest"
        $URL = (Invoke-WebRequest -Uri $URL).Content | ConvertFrom-Json |
            Select-Object -ExpandProperty "assets" |
            Where-Object "browser_download_url" -Match '.msixbundle' |
            Select-Object -ExpandProperty "browser_download_url"

        # Download
        Invoke-WebRequest -Uri $URL -OutFile "Setup.msix" -UseBasicParsing -ErrorAction SilentlyContinue -ErrorVariable ev

        If($ev){
            Cricical_Error -ev $ev -Wiz_Message "Unable to connect to WinGet. Are you sure the unit is connected to the internet?" -Allow_Continue "False"
            }
            Write-Host "Update downloaded from Winget - Installing... " -ForegroundColor Yellow

        # Install
        Add-AppxPackage -Path "Setup.msix" -ErrorAction SilentlyContinue -ErrorVariable ev
        If($ev){
            Cricical_Error -ev $ev -Wiz_Message "Downloaded Winget, but unable to install. Aborted" -Allow_Continue "False"
            }
        Write-Host "Installed Update! " -ForegroundColor Green

        # Delete File
        Write-Host "Removing unneeded installation file..." -ForegroundColor Yellow
        Remove-Item "Setup.msix" -ErrorAction SilentlyContinue -ErrorVariable ev
        If($ev){
            Add_Error -err_msg $ev -wiz_rec "Unable to automatically remove Setup.msix for WinGet - Please manually remove"
            }
        Write-Host "Installed WinGet Update! " -ForegroundColor Green


   

    ###2 - Install Google Chrome###
        Update_Steps -name "Installing Google Chrome"
        Write-Host "Getting latest Chrome version..." -ForegroundColor Yellow
        $Path = $env:TEMP
        $Installer = "chrome_installer.exe"
        Invoke-WebRequest "http://dl.google.com/chrome/install/375.126/chrome_installer.exe" -OutFile $Path\$Installer -ErrorAction SilentlyContinue -ErrorVariable ev
        If($ev){
            Add_Error -err_msg $ev -wiz_rec "Unable to download Google Chrome. Please ensure the unit is connected to the internet"
            }Else{
                Write-Host "Chrome Downloaded! - Installing..." -ForegroundColor Yellow
                Start-Process -FilePath $Path\$Installer -Args "/silent /install" -Verb RunAs -Wait -ErrorAction SilentlyContinue -ErrorVariable ev
                If($ev){
                    Add_Error -err_msg $ev -wiz_rec "Downloaded Chrome, but couldn't install. Please Install Manually"
                }Else{
                    Write-Host "Chrome Installed! Removing installation file..." -ForegroundColor Yellow
                    Remove-Item $Path\$Installer
                    Write-Host "Google Chrome Installed Sucessfully" -ForegroundColor Green
                }
            }

    ###3 - Install Adobe Reader###
    Update_Steps -name "Installing Adobe Reader"
    $AdobeInstalled = Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | where {$_.DisplayName -like "Adobe Acrobat*"}
    If($AdobeInstalled -eq $null){
        Write-Host "Getting latest Adobe Reader version..." -ForegroundColor Yellow
        Try{
        winget install -e --id Adobe.Acrobat.Reader.64-bit --accept-source-agreements --accept-package-agreements
        }Catch{
            Add_Error -err_msg $ev -wiz_rec "Failed to install Adobe Reader. Please Install Manually"     
        }Finally{
            Write-Host "Adobe Reader Installation Complete!" -ForegroundColor Green
        }
    }Else{
        Write-Host "Adobe Reader already installed"
        }

    ###4 - Install VLC Media Player###
    Update_Steps -name "Installing VLC Media Player"
    Write-Host "Getting latest VLC version..." -ForegroundColor Yellow
    Try{
    winget install -e --id VideoLAN.VLC --accept-source-agreements --accept-package-agreements
    }Catch{
        Add_Error -err_msg $ev -wiz_rec "Failed to install VLC. Please Install Manually"     
    }Finally{
        Write-Host "VLC Installation Complete!" -ForegroundColor Green
    }

    ###5 - Windows Updates###
    Update_Steps -name "Windows Updates Pt 1"
    Install_NuGet
    Do_Windows_Updates

    ###6 - Application Updates###
    Update_Steps -name "Application Updates"
    Do_App_Updates



} #Else
Break
}#1

2{
    ###Begin Tune Up###


    Write-Host "You have chosen to cast Tune Up. The following actions will be performed: " -ForegroundColor Cyan
    Write-Host "1 - Create a Restore Point" -ForegroundColor Cyan
    Write-Host "2 - ChkDsk" -ForegroundColor Cyan
    Write-Host "3 - DISM" -ForegroundColor Cyan
    Write-Host "4 - SFC" -ForegroundColor Cyan
    Write-Host "5 - Delete User Tmp Files" -ForegroundColor Cyan
    Write-Host "6 - Delete Operating System Tmp Files" -ForegroundColor Cyan
    Write-Host "7 - Delete Pre-Fetch Files" -ForegroundColor Cyan
    Write-Host "8 - Disk Cleanup" -ForegroundColor Cyan
    Write-Host "9 - Drive Optimization" -ForegroundColor Cyan
    Write-Host "10 - Windows Updates" -ForegroundColor Cyan
    Write-Host "11- App Updates" -ForegroundColor Cyan
    Write-Host "12 - Create Dispel Magic (Self Deletion Script)" -ForegroundColor Cyan
    Write-Host "13 - System Reboot" -ForegroundColor Cyan
    Write-Host "14 - Re-Check Windows Updates" -ForegroundColor Cyan
    Write-Host "15 - Empty Recycle Bin" -ForegroundColor Cyan
    Write-Host "16 - Remove PowerShell folder (to reset ExecutionPolicy)" -ForegroundColor Cyan
    Write-Host "17 - Delete Recent Items" -ForegroundColor Cyan
    Write-Host "18 - Run Dispel Magic (Self Deletion Script)" -ForegroundColor Cyan
    $confirm = Read-Host "Are you sure you wish to proceed? (y/n)"

    If (!($confirm -eq "y")){
        Write-Host "The magic has fizzled out. Press any key to exit and try again (cancelled)" -ForegroundColor Red
        Read-Host
        Exit
    }Else{
        Write-Host "Tune Up confirmed. The wizard is beginning his ritual" -ForegroundColor Green
        

        ###Begin Tune Up###

        ###Gather Suspect Info###
        
        Gather_Suspect_Info -Type "Tune Up" -Num_Steps 18


        ###1 - Create Restore Point###
        Update_Steps -name "Creating Restore Point"
        Create_Restore_Point

        ###2 - chkdsk enabled on next reboot###
        Update_Steps -name "Enabling chkdsk on next reboot"
        Write-Host "Enabling chkdsk on next reboot..." -ForegroundColor Yellow
        Try{
            Write-Output y|chkdsk c: /x /f /r
            }Catch{
                Add_Error -err_msg $ev -wiz_rec "Failed to enable chkdsk on next reboot. Please enable manually"     
            }Finally{
                Write-Host "chkdsk enabled on next reboot!" -ForegroundColor Green
            }

        ###3 - DISM###
        Update_Steps -name "DISM"
        Write-Host "Starting DISM..." -ForegroundColor Yellow
        Write-Warning "DISM and SFC can both take a long time to run. Magic Wand is still running. Pressing CTRL + C in the CMD window will break it if it appears to be unresponsive for a long (over 3 hours) time"
        Try{
            Start-Process -FilePath "dism.exe" -ArgumentList '/online /cleanup-image /startcomponentcleanup' -Wait
            }Catch{
                Add_Error -err_msg "dism failed to start. Command: dism.exe /online /cleanup-image /startcomponentcleanup" -wiz_rec "1st half of DISM failed. Please attempt to run manually"     
            }Finally{
                Write-Host "DISM 50% Complete!" -ForegroundColor Yellow
            }
        Try{
            Start-Process -FilePath "dism.exe" -ArgumentList '/online /cleanup-image /restorehealth' -Wait
            }Catch{
                Add_Error -err_msg "dism failed to start. Command: dism.exe /online /cleanup-image /restorehealth" -wiz_rec "2nd half of DISM failed. Please attempt to run manually"     
            }Finally{
                Write-Host "DISM Complete!" -ForegroundColor Green
            }
        

        ###4 - SFC###
        Update_Steps -name "SFC"
        Write-Host "Starting SFC..." -ForegroundColor Yellow
        Try{
            Start-Process -FilePath "sfc.exe" -ArgumentList '/scannow' -Wait  
            }Catch{
                Add_Error -err_msg "SFC failed to start. Command: sfc /scannow" -wiz_rec "SFC failed. Please attempt to run manually"     
            }Finally{
                Write-Host "SFC Complete!" -ForegroundColor Green
            }

        ###5 - Delete User Tmp Files###
        Update_Steps -name "Deleting User Tmp Files"
        Write-Host "Deleting User Tmp Files..." -ForegroundColor Yellow
        $usrTemp = "$env:USERPROFILE\AppData\Local\Temp"
        Try{
            Remove-Item -Recurse  "$usrTemp\*" -Force -ErrorAction SilentlyContinue -ErrorVariable ev
            }Catch{
                Add_Error -err_msg $ev -wiz_rec " Failed to delete tmp files at $usrTemp. Please delete manually"     
            }Finally{
                Write-Host "Temporary User files deletion sucessfully" -ForegroundColor Green 
            }
        
        ###6 - Delete Operating System Tmp Files###
        Update_Steps -name "Deleting OS Tmp Files"
        Write-Host "Deleting OS Tmp Files..." -ForegroundColor Yellow
        $WinTemp = "c:\Windows\Temp\*"
        Try{
            Remove-Item -Recurse $WinTemp -Force -ErrorAction SilentlyContinue -ErrorVariable ev 
            }Catch{
                Add_Error -err_msg $ev -wiz_rec "Failed to remove files from $WinTemp"     
            }Finally{
                Write-Host "Temporary Windows files deleted sucessfully" -ForegroundColor Green
            }

        ###7 - Delete Prefetch Files###
        Update_Steps -name "Deleting Prefetch Files"
        Write-Host "Deleting Prefetch Files..." -ForegroundColor Yellow
        $Prefetch = "c:\Windows\Prefetch\*"
        Try{
            Remove-Item -Recurse $Prefetch -Force -ErrorAction SilentlyContinue -ErrorVariable ev 
            }Catch{
                Add_Error -err_msg $ev -wiz_rec "Failed to delete Prefetch files at $Prefetch. Please delete manually"     
            }Finally{
                Write-Host "Prefetch files deleted sucessfully" -ForegroundColor Green
            }

        ###8 - Disk Cleanup###
        Update_Steps -name "Disk Cleanup"
        Write-Host "Starting Disk Cleanup..." -ForegroundColor Yellow
        Try{
            Start-Process -FilePath "cleanmgr.exe" -ArgumentList '/sagerun:1' -Wait
            }Catch{
                Add_Error -err_msg "Disk Cleanup failed to start. Command: cleanmgr /sagerun:1" -wiz_rec "Disk Cleanup failed. Please attempt to run manually"     
            }Finally{
                Write-Host "Disk Cleanup Complete!" -ForegroundColor Green
            }
        
        ###9 - Drive Optimization###
        Update_Steps -name "Drive Optimization"
        Write-Host "Starting Drive Optimization..." -ForegroundColor Yellow
        Try{
            Optimize-Volume -DriveLetter C 
            }Catch{
                Add_Error -err_msg "Drive Optimization failed to start. Command: dfrgui /C" -wiz_rec "Drive Optimization failed. Please attempt to run manually"     
            }Finally{
                Write-Host "Drive Optimization Complete!" -ForegroundColor Green
            }
        
        ###10 - Windows Updates###
        Update_Steps -name "Windows Update Pt 1"
        Install_NuGet
        Do_Windows_Updates

        ###11 - App Updates###
        Update_Steps -name "App Updates"
        Do_App_Updates

    }
Break
}

}#Switch

###Create Dispel Magic###

Write-Host "The first part of the ritual is complete. Saving progress and preparing for reboot.." -ForegroundColor Yellow

Update_Steps -name "Create Dispel Magic Script"

Write-Host "Creating Dispel Magic..." -ForegroundColor Yellow
$DispelMagicContents = @"
    @echo OFF
    PowerShell.exe -NoProfile -Command "& {Start-Process -FilePath $env:USERPROFILE\Desktop\Shawns_Magic_Wand.exe -Verb RunAs}"
    

"@

New-Item -Path "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp" -name "Dispel_Magic.bat" -Type "file" -Value $DispelMagicContents

###System Reboot###

Update_Steps -name "System Reboot"
Happy_Beeps
$wshell = New-Object -ComObject Wscript.Shell
$wshell.Popup("The wizard has completed this part of his ritual. The unit will be rebooted in 30 seconds. When the system reboots and you log in, be sure to hit YES on the UAC prompt to continue the magic",30,"Ritual Complete",0x0)
shutdown /r /t 0
}
